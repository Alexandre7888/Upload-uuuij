<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste WebAuthn - Biometria Real</title>
</head>
<body>
    <h1>Teste de Autenticação Biométrica (WebAuthn)</h1>
    
    <div id="status"></div>
    
    <div>
        <h2>Registrar Dispositivo</h2>
        <button onclick="register()">Registrar Biometria</button>
    </div>
    
    <div>
        <h2>Autenticar</h2>
        <button onclick="authenticate()">Usar Biometria</button>
    </div>
    
    <div>
        <h2>Verificar Suporte</h2>
        <button onclick="checkSupport()">Verificar Suporte do Navegador</button>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        
        // Verificar se o navegador suporta WebAuthn
        function checkSupport() {
            if (window.PublicKeyCredential) {
                statusDiv.innerHTML = '<p style="color: green;">✅ Navegador compatível com WebAuthn!</p>';
                
                // Verificar se há autenticadores disponíveis
                PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
                    .then(available => {
                        if (available) {
                            statusDiv.innerHTML += '<p style="color: green;">✅ Autenticador biométrico disponível!</p>';
                        } else {
                            statusDiv.innerHTML += '<p style="color: orange;">⚠️ Autenticador biométrico não disponível</p>';
                        }
                    });
            } else {
                statusDiv.innerHTML = '<p style="color: red;">❌ Navegador NÃO compatível com WebAuthn</p>';
            }
        }

        // Registrar nova credencial biométrica
        async function register() {
            statusDiv.innerHTML = '<p>Aguardando registro biométrico...</p>';
            
            try {
                // Em um sistema real, isso viria do servidor
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const publicKeyCredentialCreationOptions = {
                    challenge: challenge,
                    rp: {
                        name: "Meu Site de Teste",
                        id: window.location.hostname
                    },
                    user: {
                        id: new Uint8Array(16),
                        name: "usuario@teste.com",
                        displayName: "Usuário Teste"
                    },
                    pubKeyCredParams: [
                        {
                            type: "public-key",
                            alg: -7 // ES256
                        }
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform", // Biometria integrada
                        userVerification: "required"
                    },
                    timeout: 60000,
                    attestation: "direct"
                };

                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                statusDiv.innerHTML = '<p style="color: green;">✅ Biometria registrada com sucesso!</p>';
                console.log('Credencial registrada:', credential);
                
                // Em um sistema real, enviar a credencial para o servidor
                
            } catch (error) {
                console.error('Erro no registro:', error);
                statusDiv.innerHTML = `<p style="color: red;">❌ Erro no registro: ${error.message}</p>`;
            }
        }

        // Autenticar com biometria
        async function authenticate() {
            statusDiv.innerHTML = '<p>Aguardando autenticação biométrica...</p>';
            
            try {
                // Em um sistema real, isso viria do servidor
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const publicKeyCredentialRequestOptions = {
                    challenge: challenge,
                    allowCredentials: [], // Deixar vazio para permitir qualquer credencial registrada
                    rpId: window.location.hostname,
                    timeout: 60000,
                    userVerification: "required"
                };

                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                statusDiv.innerHTML = '<p style="color: green;">✅ Autenticação biométrica bem-sucedida!</p>';
                console.log('Assertion:', assertion);
                
                // Em um sistema real, enviar a assertion para o servidor para verificação
                
            } catch (error) {
                console.error('Erro na autenticação:', error);
                statusDiv.innerHTML = `<p style="color: red;">❌ Erro na autenticação: ${error.message}</p>`;
            }
        }

        // Verificar suporte ao carregar a página
        window.onload = checkSupport;
    </script>
</body>
</html>